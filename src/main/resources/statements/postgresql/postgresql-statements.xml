<?xml version="1.0" encoding="UTF-8"?>
<statements>
    <statement>
        <name>Размер БД</name>
        <description>Использование диска указанной базой данных</description>
        <enabled>true</enabled>
        <expression>SELECT pg_database_size('{1}') AS db_size</expression>
        <input-params>
            <input-param>
                <value>template0</value>
                <default-value>current_database()</default-value>
                <mask>1</mask>
            </input-param>
        </input-params>
        <output-params>
            <output-param>
                <column-name>db_size</column-name>
                <java-type>long</java-type>
                <regex-pattern>\d+</regex-pattern>
            </output-param>
        </output-params>
        <alerts>
            <alert on="cell-of-each-row" column-name="db_size">
                <condition>greater-than-required</condition>
                <required>10000000</required>
                <message show="only-value">
                    <value>Размер базы данных ${1} превышает допустимое значение ${required}</value>
                </message>
                <type>error</type>
            </alert>
            <alert on="cell-of-each-row" column-name="db_size">
                <condition>less-than-required</condition>
                <required>1000</required>
                <message show="only-value">
                    <value>Размер базы данных ${1} ниже определенного значения ${required}</value>
                </message>
                <type>warning</type>
            </alert>
            <alert on="cell-of-each-row" column-name="db_size">
                <condition>equal-to-required</condition>
                <required>10000</required>
                <message show="only-value">
                    <value>Размер базы данных ${1} равен ${required}</value>
                </message>
                <type>info</type>
            </alert>
        </alerts>
    </statement>
    <statement>
        <name>Deadlock</name>
        <description>Показ deadlock`ов</description>
        <enabled>true</enabled>
        <alerts>
            <alert on="row">
                <condition>is-exist-row</condition>
                <message show="output-params">
                    <value>Обнаружен deadlock</value>
                </message>
                <type>error</type>
            </alert>
        </alerts>
        <expression>
            SELECT
                bl.pid                 AS blocked_pid,
                a.usename              AS blocked_user,
                a.query                AS blocked_statement,
                now() - a.query_start  AS blocked_duration,
                ka.query               AS blocking_statement,
                now() - ka.query_start AS blocking_duration,
                kl.pid                 AS blocking_pid,
                ka.usename             AS blocking_user,
                bl.mode                AS level
            FROM
                pg_catalog.pg_locks AS bl
                JOIN pg_stat_activity AS a ON a.pid = bl.pid
                JOIN pg_catalog.pg_locks AS kl ON kl.transactionid = bl.transactionid AND kl.pid != bl.pid
                JOIN pg_stat_activity AS ka ON ka.pid = kl.pid
            WHERE
                NOT bl.granted
            ORDER BY blocked_duration DESC;
        </expression>
        <postgresql-version>9.5</postgresql-version>
        <output-params>
            <output-param>
                <column-name>blocked_pid</column-name>
                <description>Идентификатор заблокированного процесса</description>
                <java-type>int</java-type>
                <regex-pattern>\d+</regex-pattern>
            </output-param>
            <output-param>
                <column-name>blocked_user</column-name>
                <description>Заблокированный пользователь</description>
                <java-type>string</java-type>
                <regex-pattern>.*</regex-pattern>
            </output-param>
            <output-param>
                <column-name>blocked_statement</column-name>
                <description>Заблокированное SQL-выражение</description>
                <java-type>string</java-type>
                <regex-pattern>.*</regex-pattern>
            </output-param>
            <output-param>
                <column-name>blocked_duration</column-name>
                <description>Длительность блокировки у заблокированного</description>
                <java-type>timestamp with time zone</java-type>
                <!--00:01:40.200434-->
                <regex-pattern>(\d{2}:)*?(\d{2}\.\d*)</regex-pattern>
            </output-param>
            <output-param>
                <column-name>blocking_statement</column-name>
                <description>Блокирующее SQL-выражение</description>
                <java-type>string</java-type>
                <regex-pattern>.*</regex-pattern>
            </output-param>
            <output-param>
                <column-name>blocking_duration</column-name>
                <description>Длительность блокировки у блокирующего</description>
                <java-type>timestamp with time zone</java-type>
                <!--00:01:40.200434-->
                <regex-pattern>(\d{2}:)*?(\d{2}\.\d*)</regex-pattern>
            </output-param>
            <output-param>
                <column-name>blocking_pid</column-name>
                <description>Идентификатор блокирующего процесса</description>
                <java-type>int</java-type>
                <regex-pattern>\d+</regex-pattern>
            </output-param>
            <output-param>
                <column-name>blocking_user</column-name>
                <description>Блокирующий пользователь</description>
                <java-type>string</java-type>
                <regex-pattern>.*</regex-pattern>
            </output-param>
            <output-param>
                <column-name>level</column-name>
                <description>Уровень</description>
                <java-type>string</java-type>
                <regex-pattern>.*</regex-pattern>
            </output-param>
        </output-params>
    </statement>
</statements>